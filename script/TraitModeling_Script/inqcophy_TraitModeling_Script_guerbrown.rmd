---
title: "Synergus Trait Modeling Script"
author: "G. Brown"
date: "2023-02-28"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Purpose: Computationally simulate stochastic mapping of ancestral states in the Synergus phylogeny using previously established methods for deciding models.

#### Initialization

```{r message=TRUE, warning=FALSE}
library(ape)
library(phytools)
library(geiger)
library(corHMM)
```

#### Path to data

```{r warning=FALSE, include=FALSE}
setwd("//wsl.localhost/Ubuntu/home/guerbrown/github_local/biol-4386-course-project-guerbrown/data/TraitModeling")
tree <- "//wsl.localhost/Ubuntu/home/guerbrown/github_local/biol-4386-course-project-guerbrown/data/TraitModeling/inqcophy_traitmodeling_SynTree_guerbrown.nex"
traits <- "//wsl.localhost/Ubuntu/home/guerbrown/github_local/biol-4386-course-project-guerbrown/data/TraitModeling/inqcophy_traitmodeling_TraitData_guerbrown.csv"
```

##### Data Import

```{r include=FALSE}
# Import
S <- readNexus(tree)
# Rooting the phylogeny based on a version of the tree with an outgroup and plotting
root.phylo(S, 28, resolve.root = T)
# .csv
data <- read.csv(traits, row.names = 1)
```

### Ancestral State Reconstructions
##### To do this, I will be using the most likely model for the reconstruction of each trait. These models were decided using a seperate script, which is also provided in this folder. This script will not be run by default as it is extremely computationally expensive. I would recommend running it as a job through an HPC.  
##### One additional note, some of these models will be consider variables discrete and other polymorphic. This was decided by G. Brown and A. Forbes depending on ecology, parsimony, and state reconstruction accuracy. 

### Oak Section 

### Model Recapitulation
##### Note: This first chunk of code will contain annotations, the others will not. Please see the README.md for more information on generating this same procedure.

```{r oak_section POLYMORPHIC, fig.height=7, fig.width=12.5, fig.align='center'}
oak_section <- setNames(data$oak_section, rownames(data))
# Rename the levels of the variable 
levels(oak_section) <- unique(data$oak_section)
# Recapitulation of the best fit model
oak_section.ER <- fitpolyMk(S, oak_section, model = "ER")
#pull states off the fitted model object
oak_sectionxx <- apply(oak_section.ER$data,1,
            function(x,ss) ss[which(x==1)],
            ss=colnames(oak_section.ER$data))
#corHMM does not like to work with + so let's replace those with /
oak_sectionxx <- gsub("+","/", oak_sectionxx, fixed=TRUE)
#build corHMM data frame
oak_section.data <- data.frame(Genus_sp = names(oak_sectionxx), oak_section = oak_sectionxx)
#Pull out model design matrix from the fitted object
oak_section_rate.mat <- oak_section.ER$index.matrix
oak_section_rate.mat[oak_section_rate.mat==0] <- NA
colnames(oak_section_rate.mat) <- rownames(oak_section_rate.mat) <- gsub("+","/", colnames(oak_section_rate.mat), fixed=TRUE)
oak_sectionind <- order(colnames(oak_section_rate.mat))
oak_section_rate.mat <- oak_section_rate.mat[oak_sectionind, oak_sectionind]
#Ancestral States
oak_section_fit.marginal <- corHMM(S, oak_section.data,
                     rate.mat = oak_section_rate.mat,
                     node.states = "marginal",
                     rate.cat = 1, p = oak_section.ER$rates,
                     root.p = oak_section.ER$pi)
#Marginal states are stores in $states. Extract this and ensure the model is consistent
oak_sectionasr <- oak_section_fit.marginal$states
colnames(oak_sectionasr) <- colnames(oak_section_rate.mat)
colnames(oak_sectionasr) <- gsub("/","+", colnames(oak_sectionasr))

# Adding these to the figure

svg("/home/guerbrown/github_local/biol-4386-course-project-guerbrown/output/inqcophy_traitmodeling_oak_section_guerbrown.svg", width = 20, height = 10)

oak_sectionpp <- matrix(0, length(oak_section), 4, dimnames = list(names(oak_section), c("Lobatae","Quercus", "Virentes", "Quercus+Virentes")))
plot.phylo(S, type = "fan", cex = 1.1, align.tip.label = F, lwd = 2, label.offset = 0.05, use.edge.length = F, open.angle =  163, node.depth = 100)
oak_sectionX <- strsplit(setNames(as.character(oak_section_rate.mat), names(oak_section_rate.mat)),"+", fixed=TRUE)
pies <- matrix(0, Ntip(S),3,
	dimnames=list(S$tip.label,
	c("1", "2", "3")))
for(i in 1:Ntip(S)) 
	pies[S$tip.label[i],
		oak_sectionX[[S$tip.label[i]]]]<-
		rep(1/length(oak_sectionX[[S$tip.label[i]]]),
		length(oak_sectionX[[S$tip.label[i]]]))
oak_sectioncols <- setNames(c("firebrick1", "dodgerblue1", "grey15"),
	c("Quercus", "Lobatae","Virentes"))
par(fg="white")
oak_section <- setNames(data$oak_section, data$Synergus)
oak_sectionxx <- strsplit(as.character(oak_section), split = "+", fixed = T)
oak_sectionpp <- matrix(0, length(oak_section), 4, dimnames = list(names(oak_section), c("Lobatae","Quercus", "Virentes", "Quercus+Virentes")))
for (i in 1:nrow(oak_sectionpp)) oak_sectionpp[i,oak_sectionxx[[i]]]<-1/length(oak_sectionxx[[i]])
tiplabels(pie = oak_sectionpp, piecol = oak_sectioncols, cex=0.3)
par(fg="white")
piecol <- oak_sectioncols
for(i in 1:ncol(oak_sectionasr)){
	oak_sectionnn <- strsplit(colnames(oak_sectionasr)[i],"+", fixed=TRUE)[[1]]
	if(length(oak_sectionnn)==1) piecol[i] <- oak_sectioncols[oak_sectionnn]
	else if(length(oak_sectionnn)==2) piecol[i] <- colorRampPalette(oak_sectioncols[oak_sectionnn])(3)[2]
	else piecol[i]<-"black"
}
names(piecol)<-colnames(oak_sectionasr)
par(fg="white")
nodelabels(pie = oak_sectionasr, piecol = oak_sectioncols,cex=0.40)
par(fg="black")
legend("bottom", c("Lobatae", "Quercus","Virentes"), pch = 21, pt.bg = c("firebrick1", "dodgerblue1", "grey15"), pt.cex = 2, title = "Oak Section", cex = 1)

dev.off()
```

### Cynip Generation

```{r cynip_generation POLYMORPHIC, fig.height=7, fig.width=12.5, fig.align='center'}
cynip_generation <- setNames(data$cynip_generation, rownames(data))
levels(cynip_generation) <- unique(data$cynip_generation)
cynip_generation.ER <- fitpolyMk(S, cynip_generation, model = "ER")
cynip_generationxx <- apply(cynip_generation.ER$data,1,
            function(x,ss) ss[which(x==1)],
            ss=colnames(cynip_generation.ER$data))
cynip_generationxx <- gsub("+","/", cynip_generationxx, fixed=TRUE)
cynip_generation.data <- data.frame(Genus_sp = names(cynip_generationxx), cynip_generation = cynip_generationxx)
cynip_generation_rate.mat <- cynip_generation.ER$index.matrix
cynip_generation_rate.mat[cynip_generation_rate.mat==0] <- NA
colnames(cynip_generation_rate.mat) <- rownames(cynip_generation_rate.mat) <- gsub("+","/", colnames(cynip_generation_rate.mat), fixed=TRUE)
cynip_generationind <- order(colnames(cynip_generation_rate.mat))
cynip_generation_rate.mat <- cynip_generation_rate.mat[cynip_generationind, cynip_generationind]
cynip_generation_fit.marginal <- corHMM(S, cynip_generation.data,
                     rate.mat = cynip_generation_rate.mat,
                     node.states = "marginal",
                     rate.cat = 1, p = cynip_generation.ER$rates,
                     root.p = cynip_generation.ER$pi)
cynip_generationasr <- cynip_generation_fit.marginal$states
colnames(cynip_generationasr) <- colnames(cynip_generation_rate.mat)
colnames(cynip_generationasr) <- gsub("/","+", colnames(cynip_generationasr))

svg("/home/guerbrown/github_local/biol-4386-course-project-guerbrown/output/inqcophy_traitmodeling_cynip_generation_guerbrown.svg", width = 20, height = 10)

cynip_generationpp <- matrix(0, length(cynip_generation), 3, dimnames = list(names(cynip_generation), c("Asexual", "Sexual", "Asexual+Sexual")))
plot.phylo(S, type = "fan", cex = 1.1, align.tip.label = F, lwd = 2, label.offset = 0.05, use.edge.length = F, open.angle =  163, node.depth = 100)
cynip_generationX <- strsplit(setNames(as.character(cynip_generation_rate.mat), names(cynip_generation_rate.mat)),"+", fixed=TRUE)
pies <- matrix(0, Ntip(S),2,
	dimnames=list(S$tip.label,
	c("Asexual","Sexual")))
for(i in 1:Ntip(S)) 
	pies[S$tip.label[i],
		cynip_generationX[[S$tip.label[i]]]]<-
		rep(1/length(cynip_generationX[[S$tip.label[i]]]),
		length(cynip_generationX[[S$tip.label[i]]]))
cynip_generationcols <- setNames(c("firebrick1", "dodgerblue1"),
	c("Asexual","Sexual"))
par(fg="white")
cynip_generation <- setNames(data$cynip_generation, data$Synergus)
cynip_generationxx <- strsplit(as.character(cynip_generation), split = "+", fixed = T)
cynip_generationpp <- matrix(0, length(cynip_generation), 3, dimnames = list(names(cynip_generation), c("Asexual", "Sexual", "Asexual+Sexual")))
for (i in 1:nrow(cynip_generationpp)) cynip_generationpp[i,cynip_generationxx[[i]]]<-1/length(cynip_generationxx[[i]])
tiplabels(pie = cynip_generationpp, piecol = cynip_generationcols, cex=0.3)
par(fg="white")
piecol <- cynip_generationcols
for(i in 1:ncol(cynip_generationasr)){
	cynip_generationnn <- strsplit(colnames(cynip_generationasr)[i],"+", fixed=TRUE)[[1]]
	if(length(cynip_generationnn)==1) piecol[i] <- cynip_generationcols[cynip_generationnn]
	else if(length(cynip_generationnn)==2) piecol[i] <- colorRampPalette(cynip_generationcols[cynip_generationnn])(3)[2]
	else piecol[i]<-"black"
}
names(piecol)<-colnames(cynip_generationasr)
par(fg="white")
nodelabels(pie = cynip_generationasr, piecol = cynip_generationcols,cex=0.40)
par(fg="black")
legend("bottom", c("Asexual", "Sexual"), pch = 21, pt.bg = c("firebrick1", "dodgerblue1"), pt.cex = 2, title = "Gall Former Generation", cex = 1)

dev.off()
```

### Mono/Polythalamous

```{r mono.polythalamous POLYMORPHIC, fig.height=7, fig.width=12.5, fig.align='center'}
mono.polythalamous <- setNames(data$mono.polythalamous, rownames(data))
levels(mono.polythalamous) <- unique(data$mono.polythalamous)
mono.polythalamous.ER <- fitpolyMk(S, mono.polythalamous, model = "ER")
mono.polythalamousxx <- apply(mono.polythalamous.ER$data,1,
            function(x,ss) ss[which(x==1)],
            ss=colnames(mono.polythalamous.ER$data))
mono.polythalamousxx <- gsub("+","/", mono.polythalamousxx, fixed=TRUE)
mono.polythalamous.data <- data.frame(Genus_sp = names(mono.polythalamousxx), mono.polythalamous = mono.polythalamousxx)
mono.polythalamous_rate.mat <- mono.polythalamous.ER$index.matrix
mono.polythalamous_rate.mat[mono.polythalamous_rate.mat==0] <- NA
colnames(mono.polythalamous_rate.mat) <- rownames(mono.polythalamous_rate.mat) <- gsub("+","/", colnames(mono.polythalamous_rate.mat), fixed=TRUE)
mono.polythalamousind <- order(colnames(mono.polythalamous_rate.mat))
mono.polythalamous_rate.mat <- mono.polythalamous_rate.mat[mono.polythalamousind, mono.polythalamousind]
mono.polythalamous_fit.marginal <- corHMM(S, mono.polythalamous.data,
                     rate.mat = mono.polythalamous_rate.mat,
                     node.states = "marginal",
                     rate.cat = 1, p = mono.polythalamous.ER$rates,
                     root.p = mono.polythalamous.ER$pi)
mono.polythalamousasr <- mono.polythalamous_fit.marginal$states
colnames(mono.polythalamousasr) <- colnames(mono.polythalamous_rate.mat)
colnames(mono.polythalamousasr) <- gsub("/","+", colnames(mono.polythalamousasr))

svg("/home/guerbrown/github_local/biol-4386-course-project-guerbrown/output/inqcophy_traitmodeling_mono.polythalamous_guerbrown.svg", width = 20, height = 10)

mono.polythalamouspp <- matrix(0, length(mono.polythalamous), 3, dimnames = list(names(mono.polythalamous), c("0", "1", "0+1")))
plot.phylo(S, type = "fan", cex = 1.1, align.tip.label = F, lwd = 2, label.offset = 0.05, use.edge.length = F, open.angle =  163, node.depth = 100)
mono.polythalamousX <- strsplit(setNames(as.character(mono.polythalamous_rate.mat), names(mono.polythalamous_rate.mat)),"+", fixed=TRUE)
pies <- matrix(0, Ntip(S),2,
	dimnames=list(S$tip.label,
	c("0", "1")))
for(i in 1:Ntip(S)) 
	pies[S$tip.label[i],
		mono.polythalamousX[[S$tip.label[i]]]]<-
		rep(1/length(mono.polythalamousX[[S$tip.label[i]]]),
		length(mono.polythalamousX[[S$tip.label[i]]]))
mono.polythalamouscols <- setNames(c("firebrick1", "dodgerblue1"),
	c("0", "1"))
par(fg="white")
mono.polythalamous <- setNames(data$mono.polythalamous, data$Synergus)
mono.polythalamousxx <- strsplit(as.character(mono.polythalamous), split = "+", fixed = T)
mono.polythalamouspp <- matrix(0, length(mono.polythalamous), 3, dimnames = list(names(mono.polythalamous), c("0", "1", "0+1")))
for (i in 1:nrow(mono.polythalamouspp)) mono.polythalamouspp[i,mono.polythalamousxx[[i]]]<-1/length(mono.polythalamousxx[[i]])
tiplabels(pie = mono.polythalamouspp, piecol = mono.polythalamouscols, cex=0.3)
par(fg="white")
piecol <- mono.polythalamouscols
for(i in 1:ncol(mono.polythalamousasr)){
	mono.polythalamousnn <- strsplit(colnames(mono.polythalamousasr)[i],"+", fixed=TRUE)[[1]]
	if(length(mono.polythalamousnn)==1) piecol[i] <- mono.polythalamouscols[mono.polythalamousnn]
	else if(length(mono.polythalamousnn)==2) piecol[i] <- colorRampPalette(mono.polythalamouscols[mono.polythalamousnn])(3)[2]
	else piecol[i]<-"black"
}
names(piecol)<-colnames(mono.polythalamousasr)
par(fg="white")
nodelabels(pie = mono.polythalamousasr, piecol = mono.polythalamouscols,cex=0.40)
par(fg="black")
legend("bottom", c("Monothalamous", "Polythalamous"), pch = 21, pt.bg = c("firebrick1", "dodgerblue1"), pt.cex = 2, title = "Chamber/Cells of Cynipini", cex = 1)

dev.off()
```

### Gall Size

```{r gall_size POLYMORPHIC, fig.height=7, fig.width=12.5, fig.align='center'}
gall_size <- setNames(data$gall_size, rownames(data))
levels(gall_size) <- unique(data$gall_size)
gall_size.ER <- fitpolyMk(S, gall_size, model = "ER")
gall_sizexx <- apply(gall_size.ER$data,1,
            function(x,ss) ss[which(x==1)],
            ss=colnames(gall_size.ER$data))
gall_sizexx <- gsub("+","/", gall_sizexx, fixed=TRUE)
gall_size.data <- data.frame(Genus_sp = names(gall_sizexx), gall_size = gall_sizexx)
gall_size_rate.mat <- gall_size.ER$index.matrix
gall_size_rate.mat[gall_size_rate.mat==0] <- NA
colnames(gall_size_rate.mat) <- rownames(gall_size_rate.mat) <- gsub("+","/", colnames(gall_size_rate.mat), fixed=TRUE)
gall_sizeind <- order(colnames(gall_size_rate.mat))
gall_size_rate.mat <- gall_size_rate.mat[gall_sizeind, gall_sizeind]
gall_size_fit.marginal <- corHMM(S, gall_size.data,
                     rate.mat = gall_size_rate.mat,:
                     node.states = "marginal",
                     rate.cat = 1, p = gall_size.ER$rates,
                     root.p = gall_size.ER$pi)
gall_sizeasr <- gall_size_fit.marginal$states
colnames(gall_sizeasr) <- colnames(gall_size_rate.mat)
colnames(gall_sizeasr) <- gsub("/","+", colnames(gall_sizeasr))

svg("/home/guerbrown/github_local/biol-4386-course-project-guerbrown/output/inqcophy_traitmodeling_gall_size_guerbrown.svg", width = 20, height = 10)

gall_sizepp <- matrix(0, length(gall_size), 5, dimnames = list(names(gall_size), c("1", "2", "3", "1+2", "2+3")))
plot.phylo(S, type = "fan", cex = 1.1, align.tip.label = F, lwd = 2, label.offset = 0.05, use.edge.length = F, open.angle =  163, node.depth = 100)
gall_sizeX <- strsplit(setNames(as.character(gall_size_rate.mat), names(gall_size_rate.mat)),"+", fixed=TRUE)
pies <- matrix(0, Ntip(S),3,
	dimnames=list(S$tip.label,
	c("1", "2", "3")))
for(i in 1:Ntip(S)) 
	pies[S$tip.label[i],
		gall_sizeX[[S$tip.label[i]]]]<-
		rep(1/length(gall_sizeX[[S$tip.label[i]]]),
		length(gall_sizeX[[S$tip.label[i]]]))
gall_sizecols <- setNames(c("firebrick1", "dodgerblue1", "grey15"),
	c("1", "2", "3"))
par(fg="white")
gall_size <- setNames(data$gall_size, data$Synergus)
gall_sizexx <- strsplit(as.character(gall_size), split = "+", fixed = T)
gall_sizepp <- matrix(0, length(gall_size), 5, dimnames = list(names(gall_size), c("1", "2", "3", "1+2", "2+3")))
for (i in 1:nrow(gall_sizepp)) gall_sizepp[i,gall_sizexx[[i]]]<-1/length(gall_sizexx[[i]])
tiplabels(pie = gall_sizepp, piecol = gall_sizecols, cex=0.3)
par(fg="white")
piecol <- gall_sizecols
for(i in 1:ncol(gall_sizeasr)){
	gall_sizenn <- strsplit(colnames(gall_sizeasr)[i],"+", fixed=TRUE)[[1]]
	if(length(gall_sizenn)==1) piecol[i] <- gall_sizecols[gall_sizenn]
	else if(length(gall_sizenn)==2) piecol[i] <- colorRampPalette(gall_sizecols[gall_sizenn])(3)[2]
	else piecol[i]<-"black"
}
names(piecol)<-colnames(gall_sizeasr)
par(fg="white")
nodelabels(pie = gall_sizeasr, piecol = gall_sizecols,cex=0.40)
par(fg="black")
legend("bottom", c("1", "2", "3"), pch = 21, pt.bg = c("firebrick1", "dodgerblue1", "grey15"), pt.cex = 2, title = "Gall Size", cex = 1)

dev.off()
```

### cluster

```{r cluster POLYMORPHIC, fig.height=7, fig.width=12.5, fig.align='center'}
cluster <- setNames(data$cluster, rownames(data))
levels(cluster) <- unique(data$cluster)
cluster.ER <- fitpolyMk(S, cluster, model = "ER")
clusterxx <- apply(cluster.ER$data,1,
            function(x,ss) ss[which(x==1)],
            ss=colnames(cluster.ER$data))
clusterxx <- gsub("+","/", clusterxx, fixed=TRUE)
cluster.data <- data.frame(Genus_sp = names(clusterxx), cluster = clusterxx)
cluster_rate.mat <- cluster.ER$index.matrix
cluster_rate.mat[cluster_rate.mat==0] <- NA
colnames(cluster_rate.mat) <- rownames(cluster_rate.mat) <- gsub("+","/", colnames(cluster_rate.mat), fixed=TRUE)
clusterind <- order(colnames(cluster_rate.mat))
cluster_rate.mat <- cluster_rate.mat[clusterind, clusterind]
cluster_fit.marginal <- corHMM(S, cluster.data,
                     rate.mat = cluster_rate.mat,
                     node.states = "marginal",
                     rate.cat = 1, p = cluster.ER$rates,
                     root.p = cluster.ER$pi)
clusterasr <- cluster_fit.marginal$states
colnames(clusterasr) <- colnames(cluster_rate.mat)
colnames(clusterasr) <- gsub("/","+", colnames(clusterasr))

svg("/home/guerbrown/github_local/biol-4386-course-project-guerbrown/output/inqcophy_traitmodeling_cluster_guerbrown.svg", width = 20, height = 10)

clusterpp <- matrix(0, length(cluster), 3, dimnames = list(names(cluster), c("0", "1", "0+1")))
plot.phylo(S, type = "fan", cex = 1.1, align.tip.label = F, lwd = 2, label.offset = 0.05, use.edge.length = F, open.angle =  163, node.depth = 100)
clusterX <- strsplit(setNames(as.character(cluster_rate.mat), names(cluster_rate.mat)),"+", fixed=TRUE)
pies <- matrix(0, Ntip(S),2,
	dimnames=list(S$tip.label,
	c("0", "1")))
for(i in 1:Ntip(S)) 
	pies[S$tip.label[i],
		clusterX[[S$tip.label[i]]]]<-
		rep(1/length(clusterX[[S$tip.label[i]]]),
		length(clusterX[[S$tip.label[i]]]))
clustercols <- setNames(c("firebrick1", "dodgerblue1"),
	c("0", "1"))
par(fg="white")
cluster <- setNames(data$cluster, data$Synergus)
clusterxx <- strsplit(as.character(cluster), split = "+", fixed = T)
clusterpp <- matrix(0, length(cluster), 3, dimnames = list(names(cluster), c("0", "1", "0+1")))
for (i in 1:nrow(clusterpp)) clusterpp[i,clusterxx[[i]]]<-1/length(clusterxx[[i]])
tiplabels(pie = clusterpp, piecol = clustercols, cex=0.3)
par(fg="white")
piecol <- clustercols
for(i in 1:ncol(clusterasr)){
	clusternn <- strsplit(colnames(clusterasr)[i],"+", fixed=TRUE)[[1]]
	if(length(clusternn)==1) piecol[i] <- clustercols[clusternn]
	else if(length(clusternn)==2) piecol[i] <- colorRampPalette(clustercols[clusternn])(3)[2]
	else piecol[i]<-"black"
}
names(piecol)<-colnames(clusterasr)
par(fg="white")
nodelabels(pie = clusterasr, piecol = clustercols,cex=0.40)
par(fg="black")
legend("bottom", c("Single Gall", "Cluster Gall"), pch = 21, pt.bg = c("firebrick1", "dodgerblue1"), pt.cex = 2, title = "Gall Clustering", cex = 1)

dev.off()
```

### Detachable

```{r detachable DISCRETE, fig.height=10, fig.width=20, fig.align='center'}
svg("/home/guerbrown/github_local/biol-4386-course-project-guerbrown/output/inqcophy_traitmodeling_detachable_guerbrown.svg", width = 20, height = 10)

detachable <- setNames(data$detachable, rownames(data))
levels(detachable) <- unique(data$detachable)
detachable.ER <- ace(detachable, S, model = "ER", type = "discrete")

detachablecols <- c("red", "blue", "green")
plot.phylo(S, type = "fan", cex = 2, align.tip.label = F, lwd = 3.5, label.offset = 0.1, use.edge.length = F, open.angle =  165)
detachable_DATA <- setNames(data$detachable, data$Synergus)
detachablexx <- strsplit(as.character(detachable_DATA), split = "+", fixed = T)
detachablepp <- matrix(0, length(detachable_DATA), 3, dimnames = list(names(detachable_DATA), c("0", "0+1", "1")))
for (i in 1:nrow(detachablepp)) detachablepp[i,detachablexx[[i]]]<-1/length(detachablexx[[i]])
par(fg = "transparent")
ape::tiplabels(pie = detachablepp, piecol = detachablecols, cex = 0.15)
par(fg = "black")
tiplabels(pie = to.matrix(detachable, sort(unique(detachable))),piecol = detachablecols, cex = 0.15)
nodelabels( node = 1:S$Nnode+Ntip(S),
    pie = detachable.ER$lik.anc, piecol = detachablecols, cex=0.25)
tiplabels(pie = to.matrix(detachable, sort(unique(detachable))), piecol = detachablecols, cex = 0.15)
legend("left", c("0", "1", "0+1"), pch = 21, pt.bg = c("red", "blue", "green"), pt.cex = 3, title = "Gall Detachability", cex = 1.5)

dev.off()
```

### Spines

```{r spines DISCRETE, fig.height=10, fig.width=20, fig.align='center'}
svg("/home/guerbrown/github_local/biol-4386-course-project-guerbrown/output/inqcophy_traitmodeling_spines_guerbrown.svg", width = 20, height = 10)

spines <- setNames(data$spines, rownames(data))
levels(spines) <- unique(data$spines)
spines.ER <- ace(spines, S, model = "ER", type = "discrete")

spinescols <- c("red", "blue", "green")
plot.phylo(S, type = "fan", cex = 2, align.tip.label = F, lwd = 3.5, label.offset = 0.1, use.edge.length = F, open.angle =  165)
spines_DATA <- setNames(data$spines, data$Synergus)
spinesxx <- strsplit(as.character(spines_DATA), split = "+", fixed = T)
spinespp <- matrix(0, length(spines_DATA), 3, dimnames = list(names(spines_DATA), c("0", "1+0", "1")))
for (i in 1:nrow(spinespp)) spinespp[i,spinesxx[[i]]]<-1/length(spinesxx[[i]])
par(fg = "transparent")
ape::tiplabels(pie = spinespp, piecol = spinescols, cex = 0.15)
par(fg = "black")
tiplabels(pie = to.matrix(spines, sort(unique(spines))),piecol = spinescols, cex = 0.15)
nodelabels( node = 1:S$Nnode+Ntip(S),
    pie = spines.ER$lik.anc, piecol = spinescols, cex=0.25)
tiplabels(pie = to.matrix(spines, sort(unique(spines))), piecol = spinescols, cex = 0.15)
legend("left", c("0", "1+0", "1"), pch = 21, pt.bg = c("red", "blue", "green"), pt.cex = 3, title = "Gall Spines", cex = 1.5)

dev.off()
```

### Texture


```{r texture DISCRETE, fig.height=10, fig.width=20, fig.align='center'}
svg("/home/guerbrown/github_local/biol-4386-course-project-guerbrown/output/inqcophy_traitmodeling_texture_guerbrown.svg", width = 20, height = 10)

texture <- setNames(data$texture, rownames(data))
levels(texture) <- unique(data$texture)
texture.ER <- ace(texture, S, model = "ER", type = "discrete")

texturecols <- c("red", "blue", "green")
plot.phylo(S, type = "fan", cex = 2, align.tip.label = F, lwd = 3.5, label.offset = 0.1, use.edge.length = F, open.angle =  165)
texture_DATA <- setNames(data$texture, data$Synergus)
texturexx <- strsplit(as.character(texture_DATA), split = "+", fixed = T)
texturepp <- matrix(0, length(texture_DATA), 3, dimnames = list(names(texture_DATA), c("0", "1", "1+0")))
for (i in 1:nrow(texturepp)) texturepp[i,texturexx[[i]]]<-1/length(texturexx[[i]])
par(fg = "transparent")
ape::tiplabels(pie = texturepp, piecol = texturecols, cex = 0.15)
par(fg = "black")
tiplabels(pie = to.matrix(texture, sort(unique(texture))),piecol = texturecols, cex = 0.15)
nodelabels( node = 1:S$Nnode+Ntip(S),
    pie = texture.ER$lik.anc, piecol = texturecols, cex=0.25)
tiplabels(pie = to.matrix(texture, sort(unique(texture))), piecol = texturecols, cex = 0.15)
legend("left", c("0", "1", "1+0"), pch = 21, pt.bg = c("red", "blue", "green"), pt.cex = 3, title = "Gall Texture", cex = 1.5)

dev.off()
```

### Hairs


```{r texture DISCRETE, fig.height=10, fig.width=20, fig.align='center'}
#svg("/home/guerbrown/github_local/biol-4386-course-project-guerbrown/output/inqcophy_traitmodeling_hairs_guerbrown.svg", width = 20, height = 10)

texture <- setNames(data$texture, rownames(data))
levels(texture) <- unique(data$texture)
texture.ER <- ace(texture, S, model = "ER", type = "discrete")

texturecols <- c("red", "blue", "green")
plot.phylo(S, type = "fan", cex = 2, align.tip.label = F, lwd = 3.5, label.offset = 0.1, use.edge.length = F, open.angle =  165)
texture_DATA <- setNames(data$texture, data$Synergus)
texturexx <- strsplit(as.character(texture_DATA), split = "+", fixed = T)
texturepp <- matrix(0, length(texture_DATA), 3, dimnames = list(names(texture_DATA), c("0", "1+0", "1")))
for (i in 1:nrow(texturepp)) texturepp[i,texturexx[[i]]]<-1/length(texturexx[[i]])
par(fg = "transparent")
ape::tiplabels(pie = texturepp, piecol = texturecols, cex = 0.15)
par(fg = "black")
tiplabels(pie = to.matrix(texture, sort(unique(texture))),piecol = texturecols, cex = 0.15)
nodelabels( node = 1:S$Nnode+Ntip(S),
    pie = texture.ER$lik.anc, piecol = texturecols, cex=0.25)
tiplabels(pie = to.matrix(texture, sort(unique(texture))), piecol = texturecols, cex = 0.15)
legend("left", c("0", "1+0", "1"), pch = 21, pt.bg = c("red", "blue", "green"), pt.cex = 3, title = "Gall Spines", cex = 1.5)

#dev.off()
```






























### Location

```{r location POLYMORPHIC, fig.height=10, fig.width=20, fig.align='center'}
location <- setNames(data$location, rownames(data))
levels(location) <- unique(data$location)
location.ER <- fitpolyMk(S, location, model = "ER")
locationxx <- apply(location.ER$data,1,
            function(x,ss) ss[which(x==1)],
            ss=colnames(location.ER$data))
locationxx <- gsub("+","/", locationxx, fixed=TRUE)
location.data <- data.frame(Genus_sp = names(locationxx), location = locationxx)
location_rate.mat <- location.ER$index.matrix
location_rate.mat[location_rate.mat==0] <- NA
colnames(location_rate.mat) <- rownames(location_rate.mat) <- gsub("+","/", colnames(location_rate.mat), fixed=TRUE)
locationind <- order(colnames(location_rate.mat))
location_rate.mat <- location_rate.mat[locationind, locationind]
location_fit.marginal <- corHMM(S, location.data,
                     rate.mat = location_rate.mat,
                     node.states = "marginal",
                     rate.cat = 1, p = location.ER$rates,
                     root.p = location.ER$pi)
locationasr <- location_fit.marginal$states
colnames(locationasr) <- colnames(location_rate.mat)
colnames(locationasr) <- gsub("/","+", colnames(locationasr))

#svg("/home/guerbrown/github_local/biol-4386-course-project-guerbrown/output/inqcophy_traitmodeling_location_guerbrown.svg", width = 20, height = 10)

locationpp <- matrix(0, length(location), 7, dimnames = list(names(location), c("leaf", "stem", "stem+leaf", "petiole+stem", "acorn", "bud", "bud+leaf+acorn")))
plot.phylo(S, type = "fan", cex = 2, align.tip.label = F, lwd = 3.5, label.offset = 0.1, use.edge.length = F, open.angle =  165)
locationX <- strsplit(setNames(as.character(location_rate.mat), names(location_rate.mat)),"+", fixed=TRUE)
pies <- matrix(0, Ntip(S),4,
	dimnames=list(S$tip.label,
	c("leaf", "stem", "acorn", "bud")))
for(i in 1:Ntip(S)) 
	pies[S$tip.label[i],
		locationX[[S$tip.label[i]]]]<-
		rep(1/length(locationX[[S$tip.label[i]]]),
		length(locationX[[S$tip.label[i]]]))
locationcols <- setNames(c("blue", "red", "yellow", "black"),
	c("leaf", "stem", "acorn", "bud"))
par(fg="black")
location <- setNames(data$location, data$Synergus)
locationxx <- strsplit(as.character(location), split = "+", fixed = T)
locationpp <- matrix(0, length(location), 7, dimnames = list(names(location), c("leaf", "stem", "stem+leaf", "petiole+stem", "acorn", "bud", "bud+leaf+acorn")))
for (i in 1:nrow(locationpp)) locationpp[i,location[[i]]]<-1/length(location[[i]])
tiplabels(pie = locationpp, piecol = locationcols, cex=0.15)
par(fg="black")
piecol <- locationcols
for(i in 1:ncol(locationasr)){
	locationnn <- strsplit(colnames(locationasr)[i],"+", fixed=TRUE)[[1]]
	if(length(locationnn)==1) piecol[i] <- locationcols[locationnn]
	else if(length(locationnn)==2) piecol[i] <- colorRampPalette(locationcols[locationnn])(3)[2]
	else piecol[i]<-"black"
}
names(piecol)<-colnames(locationasr)
par(fg="transparent")
nodelabels(pie = locationasr, piecol = locationcols,cex=0.25)
par(fg="black")
legend("left", c("leaf", "stem", "acorn", "bud"), pch = 21, pt.bg = c("blue", "red", "yellow", "black"), pt.cex = 3, title = "INSERT FORMAL location", cex = 1.5)
#dev.off()

locationpp <- matrix(0, length(location), 7, dimnames = list(names(location), c("leaf", "stem", "stem+leaf", "petiole+stem", "acorn", "bud", "bud+leaf+acorn")))
plot.phylo(S, type = "fan", cex = 2, align.tip.label = F, lwd = 3.5, label.offset = 0.1, use.edge.length = F, open.angle =  165)
locationX <- strsplit(setNames(as.character(location_rate.mat), names(location_rate.mat)),"+", fixed=TRUE)
pies <- matrix(0, Ntip(S),4,
	dimnames=list(S$tip.label,
	c("leaf", "stem", "acorn", "bud")))
for(i in 1:Ntip(S)) 
	pies[S$tip.label[i],
		locationX[[S$tip.label[i]]]]<-
		rep(1/length(locationX[[S$tip.label[i]]]),
		length(locationX[[S$tip.label[i]]]))
locationcols <- setNames(c("blue", "red", "yellow", "green"),
	c("0", "1"))
par(fg="black")
location <- setNames(data$location, data$Synergus)
locationxx <- strsplit(as.character(location), split = "+", fixed = T)
locationpp <- matrix(0, length(location), 7, dimnames = list(names(location), c("leaf", "stem", "stem+leaf", "petiole+stem", "acorn", "bud", "bud+leaf+acorn")))
for (i in 1:nrow(locationpp)) locationpp[i,locationxx[[i]]]<-1/length(locationxx[[i]])
tiplabels(pie = locationpp, piecol = locationcols, cex=0.15)
par(fg="black")
piecol <- locationcols
for(i in 1:ncol(locationasr)){
	locationnn <- strsplit(colnames(locationasr)[i],"+", fixed=TRUE)[[1]]
	if(length(locationnn)==1) piecol[i]<-locationcols[locationnn]
	else if(length(locationnn)==2) piecol[i] <- colorRampPalette(locationcols[locationnn])(3)[2]
	else piecol[i]<-"black"
}
names(piecol)<-colnames(locationasr)
par(fg="transparent")
nodelabels(pie = locationasr, piecol = locationcols,cex=0.25)
par(fg="black")
legend("left", c("leaf", "stem", "acorn", "bud"), pch = 21, pt.bg = c("blue", "red", "yellow", "green"), pt.cex = 3, title = "Gall Former Tissue", cex = 1.5)

```










